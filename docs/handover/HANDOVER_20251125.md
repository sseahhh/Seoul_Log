# ì¸ìˆ˜ì¸ê³„ ë¬¸ì„œ - 2025ë…„ 11ì›” 25ì¼

## ğŸ“‹ ì‘ì—… ìš”ì•½

### ì£¼ìš” ì‘ì—… ë‚´ìš©
1. Step 2 (ChromaDB) ë¹„ìš© ì¶”ì  ë²„ê·¸ ìˆ˜ì •
2. Step 4/5 asyncio event loop ì¶©ëŒ ë¬¸ì œ í•´ê²°
3. `--start-from` ì˜µì…˜ ì¶”ê°€ë¡œ íŠ¹ì • Stepë¶€í„° ì‹¤í–‰ ê°€ëŠ¥í•˜ê²Œ ê°œì„ 

---

## ğŸ› ìˆ˜ì •ëœ ë²„ê·¸

### 1. Step 2 ë¹„ìš©ì´ ë¡œê·¸ì— í‘œì‹œë˜ì§€ ì•ŠëŠ” ë¬¸ì œ

**ë¬¸ì œ:**
- Step 2 (OpenAI Embedding) ë¹„ìš©ì´ `$0.00`ìœ¼ë¡œ í‘œì‹œë¨
- ìµœì¢… ë¹„ìš© ìš”ì•½ì— OpenAI ë¹„ìš© ëˆ„ë½

**ì›ì¸:**
- `rebuild_all_db.py`ê°€ `step2_cost_tracker.costs_breakdown['openai']` í‚¤ë¥¼ ì°¾ìŒ
- ì‹¤ì œë¡œëŠ” `'embedding'` í‚¤ì— ì €ì¥ë¨

**ìˆ˜ì • íŒŒì¼:**
- `scripts/rebuild_all_db.py` (Line 378-408)

**ìˆ˜ì • ë‚´ìš©:**
```python
# Before (ì˜ëª»ëœ í‚¤)
if 'openai' in step2_cost_tracker.costs_breakdown:

# After (ì˜¬ë°”ë¥¸ í‚¤)
if 'embedding' in step2_cost_tracker.costs_breakdown:
    # embedding í‚¤ë¥¼ openai/modelsë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥
    emb = step2_cost_tracker.costs_breakdown['embedding']
    model = 'text-embedding-3-small'
```

**ê²°ê³¼:**
- Step 2 ë¹„ìš©ì´ ì •ìƒì ìœ¼ë¡œ ë¡œê·¸ì— í‘œì‹œë¨
- ìµœì¢… ë¹„ìš© ìš”ì•½ì— `text-embedding-3-small` ë¹„ìš© í¬í•¨ë¨

---

### 2. Step 4/5ì—ì„œ Event Loop ì¶©ëŒ ë¬¸ì œ

**ë¬¸ì œ:**
- 52ê°œ íŒŒì¼ ì²˜ë¦¬ ì‹œ Step 4 ì‹œì‘í•˜ìë§ˆì `RuntimeError: Event loop is closed` ì—ëŸ¬
- 10ê°œ íŒŒì¼ì€ ì •ìƒ ì‘ë™í•˜ì§€ë§Œ 52ê°œëŠ” ì‹¤íŒ¨

**ì›ì¸:**
```
Step 1: asyncio.run() â†’ Loop A ìƒì„±/ì¢…ë£Œ (ë¶ˆì™„ì „í•œ ì •ë¦¬)
Step 2: asyncio.run() â†’ Loop B ìƒì„±/ì¢…ë£Œ (ë¶ˆì™„ì „í•œ ì •ë¦¬)
Step 4: asyncio.run() â†’ Loop C ìƒì„± ì‹œë„ â†’ ì´ì „ loop ì”ì—¬ ë¦¬ì†ŒìŠ¤ ì¶©ëŒ ğŸ’¥
```

- ê° Stepë§ˆë‹¤ `asyncio.run()`ì„ í˜¸ì¶œí•˜ë©´ì„œ ìƒˆ event loop ìƒì„±
- ì´ì „ loopì˜ HTTP ì—°ê²°, Taskë“¤ì´ ì™„ì „íˆ ì •ë¦¬ë˜ì§€ ì•ŠìŒ
- 52ê°œ íŒŒì¼ ì²˜ë¦¬ ì‹œ ëˆ„ì ëœ ë¦¬ì†ŒìŠ¤ê°€ Windows í•œê³„ ì´ˆê³¼

**ìˆ˜ì • íŒŒì¼:**
1. `database/generate_ai_summaries.py` (Line 365-370)
2. `database/generate_attachment_summaries.py` (Line 372-377)

**ìˆ˜ì • ë‚´ìš©:**
```python
def generate_ai_summaries():
    # Windowsì—ì„œ nested asyncio.run() ì§€ì›
    import sys
    if sys.platform == 'win32':
        asyncio.set_event_loop_policy(asyncio.WindowsProactorEventLoopPolicy())

    return asyncio.run(generate_ai_summaries_async())
```

**í•´ê²° ë°©ë²•:**
- Windows Proactor Event Loop Policy ì„¤ì •
- ì´ì „ loop ì”ì—¬ë¬¼ ë¬´ì‹œí•˜ê³  ê°•ì œë¡œ ìƒˆ loop ìƒì„±

**í•œê³„:**
- ê·¼ë³¸ ì›ì¸ í•´ê²°ì€ ì•„ë‹˜ (ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ì—¬ì „íˆ ì¡´ì¬)
- ë™ì‘ì€ ì •ìƒì´ì§€ë§Œ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ê°€ ë¶ˆì™„ì „
- ë¡œê·¸ì— ê²½ê³  ë©”ì‹œì§€ ë°œìƒ ê°€ëŠ¥ (ë¬´ì‹œí•´ë„ ë¨)

**ê·¼ë³¸ í•´ê²°ì±… (í–¥í›„ ê°œì„ ):**
- ì „ì²´ íŒŒì´í”„ë¼ì¸ì„ í•˜ë‚˜ì˜ `async def pipeline_async()`ë¡œ í†µí•©
- `asyncio.run()` í•œ ë²ˆë§Œ í˜¸ì¶œ
- ëª¨ë“  Stepì´ ê°™ì€ event loop ì‚¬ìš©
- ì™„ë²½í•œ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬ + ë” ë¹ ë¥¸ ì‹¤í–‰ ì†ë„

---

### 3. `--start-from` ì˜µì…˜ ì¶”ê°€

**ìš”êµ¬ì‚¬í•­:**
- íŠ¹ì • Stepë¶€í„° íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì‹œì‘
- Step 1-3ì´ ì´ë¯¸ ì™„ë£Œëœ ê²½ìš° Step 4ë¶€í„° ì‹¤í–‰í•˜ê³  ì‹¶ìŒ

**ìˆ˜ì • íŒŒì¼:**
- `scripts/rebuild_all_db.py` (Line 308-533)

**ì¶”ê°€ëœ ê¸°ëŠ¥:**
```bash
# Step 4ë¶€í„° ì‹œì‘ (Step 1-3 ê±´ë„ˆë›°ê¸°)
python scripts/rebuild_all_db.py --start-from 4

# Step 5ë§Œ ì‹¤í–‰
python scripts/rebuild_all_db.py --start-from 5

# Step 2ë¶€í„° ì‹œì‘
python scripts/rebuild_all_db.py --start-from 2

# Step 3ë¶€í„° ì‹œì‘
python scripts/rebuild_all_db.py --start-from 3
```

**ë™ì‘ ë°©ì‹:**
- `--start-from N` ì˜µì…˜ ì‚¬ìš© ì‹œ Step N ì´ì „ì€ ëª¨ë‘ ê±´ë„ˆëœ€
- DB ì´ˆê¸°í™” ì•ˆ í•¨ (ê¸°ì¡´ ë°ì´í„° ìœ ì§€)
- ë¹„ìš© ì¶”ì ì€ ì‹¤í–‰ëœ Stepë§Œ ê³„ì‚°
- ë¡œê·¸ì— "ê±´ë„ˆë›°ê¸°" ë©”ì‹œì§€ í‘œì‹œ

**êµ¬í˜„ ë‚´ìš©:**
```python
# ì˜µì…˜ íŒŒì‹±
parser.add_argument("--start-from", type=int, metavar="STEP",
                    choices=[2, 3, 4, 5],
                    help="íŠ¹ì • Stepë¶€í„° ì‹œì‘")

# ê° Stepì— ì¡°ê±´ ì¶”ê°€
if not args.start_from or args.start_from <= 4:
    # Step 4 ì‹¤í–‰
else:
    # Step 4 ê±´ë„ˆë›°ê¸°
```

---

## ğŸ“ ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

### 1. `scripts/rebuild_all_db.py`
**ìˆ˜ì • ë‚´ìš©:**
- Line 308-310: `--start-from` ì˜µì…˜ ì¶”ê°€
- Line 332-333: ë¡œê¹…ì— ì˜µì…˜ í‘œì‹œ
- Line 339-347: ì´ˆê¸°í™” ê±´ë„ˆë›°ê¸° ë¡œì§
- Line 353, 372-379: Step 1 ì¡°ê±´ë¶€ ì‹¤í–‰
- Line 382-427: Step 2 ì¡°ê±´ë¶€ ì‹¤í–‰ + ë¹„ìš© ì¶”ì  ë²„ê·¸ ìˆ˜ì •
- Line 430-441: Step 3 ì¡°ê±´ë¶€ ì‹¤í–‰
- Line 444-487: Step 4 ì¡°ê±´ë¶€ ì‹¤í–‰
- Line 490-533: Step 5 ì¡°ê±´ë¶€ ì‹¤í–‰

### 2. `database/generate_ai_summaries.py`
**ìˆ˜ì • ë‚´ìš©:**
- Line 365-370: Windows Event Loop Policy ì„¤ì • ì¶”ê°€

### 3. `database/generate_attachment_summaries.py`
**ìˆ˜ì • ë‚´ìš©:**
- Line 372-377: Windows Event Loop Policy ì„¤ì • ì¶”ê°€

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. Step 2 ë¹„ìš© ì¶”ì  í™•ì¸
```bash
# 3ê°œ íŒŒì¼ë¡œ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
python scripts/rebuild_all_db.py --only-new 3

# ë¡œê·¸ í™•ì¸
tail -50 logs/pipeline_YYYYMMDD_HHMMSS.log

# í™•ì¸ ì‚¬í•­:
# - Step 2 ë¹„ìš©: $0.00XXXX (â‚©XX.XX) í‘œì‹œ
# - ìµœì¢… ìš”ì•½ì— text-embedding-3-small ë¹„ìš© í¬í•¨
```

### 2. Step 4/5 Event Loop ë¬¸ì œ í™•ì¸
```bash
# 52ê°œ íŒŒì¼ ì „ì²´ ì‹¤í–‰
python scripts/rebuild_all_db.py

# í™•ì¸ ì‚¬í•­:
# - Step 4ê°€ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ê³  ì™„ë£Œë¨
# - "Event loop is closed" ì—ëŸ¬ ì—†ìŒ
# - ê²½ê³  ë©”ì‹œì§€ëŠ” ë¬´ì‹œí•´ë„ ë¨
```

### 3. `--start-from` ì˜µì…˜ í…ŒìŠ¤íŠ¸
```bash
# Step 4ë¶€í„° ì‹¤í–‰ (Step 1-3 ì´ë¯¸ ì™„ë£Œëœ ìƒíƒœ)
python scripts/rebuild_all_db.py --start-from 4

# í™•ì¸ ì‚¬í•­:
# - Step 0-3 ê±´ë„ˆë›°ê¸° ë©”ì‹œì§€ í‘œì‹œ
# - Step 4, 5ë§Œ ì‹¤í–‰ë¨
# - ê¸°ì¡´ DB ë°ì´í„° ìœ ì§€ë¨
```

---

## ğŸ“Š í˜„ì¬ íŒŒì´í”„ë¼ì¸ êµ¬ì¡°

### Step 0: ë°ì´í„° ì´ˆê¸°í™”
- SQLite DB ì‚­ì œ
- ChromaDB ì‚­ì œ
- JSON íŒŒì¼ ì‚­ì œ (ì„ íƒì )

### Step 1: JSON ìƒì„± (md â†’ JSON)
- Gemini 2.5 Flashë¡œ íšŒì˜ë¡ íŒŒì‹±
- 10ê°œ íŒŒì¼ ë³‘ë ¬ ì²˜ë¦¬
- `asyncio.run()` ì‚¬ìš©

### Step 2: ChromaDB ì‚½ì… (JSON â†’ ChromaDB)
- OpenAI text-embedding-3-smallë¡œ ë²¡í„°í™”
- 10ê°œ íŒŒì¼ ë³‘ë ¬ ì²˜ë¦¬
- `asyncio.run()` ì‚¬ìš©

### Step 3: SQLite DB ìƒì„± (JSON â†’ SQLite)
- ë©”íƒ€ë°ì´í„° DB ìƒì„±
- ë™ê¸° ì²˜ë¦¬

### Step 4: AI ìš”ì•½ ìƒì„±
- Gemini 2.5 Flashë¡œ ì•ˆê±´ë³„ ìš”ì•½ ìƒì„±
- 10ê°œ ì•ˆê±´ ë³‘ë ¬ ì²˜ë¦¬
- `asyncio.run()` ì‚¬ìš© â† **ì´ì „ì— ì—ëŸ¬ ë°œìƒ**

### Step 5: ì²¨ë¶€ ë¬¸ì„œ ìš”ì•½ ìƒì„±
- Gemini File APIë¡œ PDF/HWP ìš”ì•½
- 10ê°œ íŒŒì¼ ë³‘ë ¬ ì²˜ë¦¬
- `asyncio.run()` ì‚¬ìš©

---

## ğŸ’¡ í–¥í›„ ê°œì„  ê³¼ì œ

### 1. Event Loop ê·¼ë³¸ í•´ê²° (ìš°ì„ ìˆœìœ„: ë†’ìŒ)
**í˜„ì¬ ìƒíƒœ:**
- Windows Policyë¡œ ì„ì‹œ í•´ê²°
- ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ì—¬ì „íˆ ì¡´ì¬

**ê°œì„  ë°©ì•ˆ:**
```python
# ì „ì²´ íŒŒì´í”„ë¼ì¸ì„ í•˜ë‚˜ì˜ async í•¨ìˆ˜ë¡œ í†µí•©
async def pipeline_async():
    gemini_client = genai.Client()
    openai_client = AsyncOpenAI()

    await step1_async(gemini_client)
    await step2_async(openai_client)
    step3_sync()
    await step4_async(gemini_client)
    await step5_async(gemini_client)

    await gemini_client.aclose()
    await openai_client.aclose()

# ë©”ì¸ì—ì„œ í•œ ë²ˆë§Œ í˜¸ì¶œ
asyncio.run(pipeline_async())
```

**ì¥ì :**
- Event Loop í•˜ë‚˜ë§Œ ì‚¬ìš©
- ì™„ë²½í•œ ë¦¬ì†ŒìŠ¤ ì •ë¦¬
- HTTP ì—°ê²° ì¬ì‚¬ìš©ìœ¼ë¡œ ë” ë¹ ë¥¸ ì†ë„
- ë©”ëª¨ë¦¬ íš¨ìœ¨ ìµœê³ 

**ì†Œìš” ì‹œê°„:** 1-2ì‹œê°„

### 2. ì¤‘ë³µ ë¼ì¸ ì²˜ë¦¬ ê°œì„ 
**í˜„ì¬:**
- 5ì¤„ ì´ìƒ ì¤‘ë³µ ê°ì§€ ì‹œ ìµœëŒ€ 3íšŒ ì¬ì‹œë„
- ì¬ì‹œë„ ì‹¤íŒ¨ ì‹œ ì¤‘ë³µ í—ˆìš©

**ê°œì„  ë°©ì•ˆ:**
- 2ë‹¨ê³„ íŒŒì‹±ì—ì„œ ì¤‘ë³µëœ ë°œì–¸ ìë™ ì œê±°
- ë˜ëŠ” ì•ˆê±´ ê²½ê³„ ì¡°ì • ë¡œì§ ì¶”ê°€

---

## ğŸ“ ëª…ë ¹ì–´ ìš”ì•½

### ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
```bash
# ì „ì²´ 52ê°œ íŒŒì¼
python scripts/rebuild_all_db.py

# ëœë¤ Nê°œ íŒŒì¼ë§Œ (í…ŒìŠ¤íŠ¸ìš©)
python scripts/rebuild_all_db.py --only-new 10

# JSON ìƒì„± ê±´ë„ˆë›°ê¸° (ê¸°ì¡´ JSON ì‚¬ìš©)
python scripts/rebuild_all_db.py --skip-json

# íŠ¹ì • Stepë¶€í„° ì‹œì‘
python scripts/rebuild_all_db.py --start-from 4
```

### ë‹¨ê³„ë³„ ë‹¨ë… ì‹¤í–‰
```bash
# Step 1ë§Œ ì‹¤í–‰
python data_processing/process_all_result_folders.py

# Step 2ë§Œ ì‹¤í–‰
python database/insert_to_chromadb_async.py

# Step 3ë§Œ ì‹¤í–‰
python database/create_agenda_database.py

# Step 4ë§Œ ì‹¤í–‰
python database/generate_ai_summaries.py

# Step 5ë§Œ ì‹¤í–‰
python database/generate_attachment_summaries.py
```

### DB í™•ì¸
```bash
# SQLite ì•ˆê±´ ìˆ˜ í™•ì¸
sqlite3 data/sqlite_DB/agendas.db "SELECT COUNT(*) FROM agendas"

# AI ìš”ì•½ ìƒì„± ìˆ˜ í™•ì¸
sqlite3 data/sqlite_DB/agendas.db "SELECT COUNT(*) FROM agendas WHERE ai_summary IS NOT NULL"

# ì²¨ë¶€ ë¬¸ì„œ ìš”ì•½ ìˆ˜ í™•ì¸
sqlite3 data/sqlite_DB/agendas.db "SELECT COUNT(*) FROM agenda_attachments WHERE ai_summary IS NOT NULL"

# ChromaDB ë²¡í„° ìˆ˜ í™•ì¸
python -c "import chromadb; c = chromadb.PersistentClient(path='data/chroma_db'); print(c.get_collection('seoul_council_meetings').count())"
```

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### 1. Event Loop ê²½ê³  ë©”ì‹œì§€
```
RuntimeError: Event loop is closed
Task exception was never retrieved
```
- íŒŒì´í”„ë¼ì¸ ì™„ë£Œ **í›„** ë°œìƒí•˜ëŠ” ê²½ê³ 
- ì‹¤ì œ ë™ì‘ì—ëŠ” ì˜í–¥ ì—†ìŒ
- **ë¬´ì‹œí•´ë„ ë¨**

### 2. 52ê°œ íŒŒì¼ ì²˜ë¦¬ ì‹œê°„
- ì˜ˆìƒ ì†Œìš” ì‹œê°„: 30-50ë¶„
- ë„¤íŠ¸ì›Œí¬ ìƒíƒœì— ë”°ë¼ ë³€ë™ ê°€ëŠ¥
- ì¤‘ê°„ì— ë©ˆì¶”ë©´ `--start-from`ìœ¼ë¡œ ì¬ì‹œì‘ ê°€ëŠ¥

### 3. ë¹„ìš©
- 10ê°œ íŒŒì¼: ì•½ $0.10 (â‚©130)
- 52ê°œ íŒŒì¼: ì•½ $0.52 (â‚©676)
- Gemini 2.5 Flash: $0.075 / 1M tokens
- OpenAI text-embedding-3-small: $0.020 / 1M tokens

---

## ğŸ“ ë¬¸ì œ ë°œìƒ ì‹œ

### Step 4/5ì—ì„œ Event Loop ì—ëŸ¬
```bash
# í•´ê²° ë°©ë²• 1: Step 4ë¶€í„° ë‹¤ì‹œ ì‹œì‘
python scripts/rebuild_all_db.py --start-from 4

# í•´ê²° ë°©ë²• 2: ë‹¨ë… ì‹¤í–‰
python database/generate_ai_summaries.py
python database/generate_attachment_summaries.py
```

### Step 2 ë¹„ìš©ì´ $0.00ìœ¼ë¡œ í‘œì‹œ
- ì´ë²ˆ ìˆ˜ì •ìœ¼ë¡œ í•´ê²°ë¨
- ì—¬ì „íˆ ë°œìƒ ì‹œ `rebuild_all_db.py` Line 384-408 í™•ì¸

### ë¡œê·¸ í™•ì¸
```bash
# ìµœì‹  ë¡œê·¸ íŒŒì¼ í™•ì¸
ls -lt logs/pipeline_*.log | head -1

# ë¡œê·¸ ë‚´ìš© í™•ì¸
tail -100 logs/pipeline_YYYYMMDD_HHMMSS.log

# ì—ëŸ¬ë§Œ í•„í„°ë§
grep -i error logs/pipeline_YYYYMMDD_HHMMSS.log
```

---

## ğŸ“š ê´€ë ¨ íŒŒì¼ ìœ„ì¹˜

### ë°ì´í„° íŒŒì¼
- ì›ë³¸ íšŒì˜ë¡: `result/ì œXXXíšŒ XXXìœ„ì›íšŒ ì œXì°¨(YYYY.MM.DD)/meeting_*.md`
- JSON ë©”íƒ€ë°ì´í„°: `data/result_txt/*.json`
- SQLite DB: `data/sqlite_DB/agendas.db`
- ChromaDB: `data/chroma_db/`
- ë¡œê·¸: `logs/pipeline_*.log`

### ì£¼ìš” ì½”ë“œ
- ë©”ì¸ íŒŒì´í”„ë¼ì¸: `scripts/rebuild_all_db.py`
- Step 1: `data_processing/process_all_result_folders.py`
- Step 2: `database/insert_to_chromadb_async.py`
- Step 3: `database/create_agenda_database.py`
- Step 4: `database/generate_ai_summaries.py`
- Step 5: `database/generate_attachment_summaries.py`
- ë¹„ìš© ì¶”ì : `utils/cost_tracker.py`

---

**ì‘ì„±ì¼:** 2025ë…„ 11ì›” 25ì¼
**ì‘ì„±ì:** Claude Code
**ë²„ì „:** 1.0
