# 작업 인수인계 문서 (2025-11-24)

**작성 일시**: 2025-11-24
**수정 일시**: 2025-11-25 (conda 환경명 수정 + 코드 실행 지침 추가)
**현재 상태**: Gemini Flash 프롬프트 개선 + 구조적 요소 필터링 완료
**다음 작업**: 첨부 문서 추출 검증 및 전체 데이터 재생성

---

## 📌 작업 원칙

### AI와 사용자의 역할 분담

**AI (Claude Code)의 역할**:
- ✅ 코드 분석 및 리뷰
- ✅ 버그 발견 및 개선 제안
- ✅ 실행 명령어 작성 및 제시
- ✅ 문서 작성 및 업데이트
- ✅ 코드 작성 및 수정

**사용자의 역할**:
- ✅ 모든 코드 실행 (테스트, 스크립트, 서버 등)
- ✅ conda 환경 활성화
- ✅ 실행 결과 확인 및 검증
- ✅ 최종 의사결정

**이유**:
- 실행 과정의 투명성 확보
- 예상치 못한 부작용 방지
- 사용자가 직접 결과 검증

---

## 🎯 오늘(11/24) 작업 내용

### 1. 문제 발견: Gemini Flash로 안건 파싱 시 첨부 문서 누락

**배경**:
- 하이브리드 파싱 시스템: Stage 1 (Gemini) + Stage 2 (순수 Python 코드)
- Gemini 2.5 Pro는 첨부 문서를 잘 추출하지만, Flash는 누락 발생
- Flash 사용 이유: 비용 절감 (Pro 대비 90% 저렴)

**발견된 문제**:
```json
// Pro 모델 결과
"attachments": [
  {"title": "검토보고서", "download_url": "https://..."},
  {"title": "조례안", "download_url": "https://..."}
]

// Flash 모델 결과 (기존)
"attachments": []  // ❌ 누락!
```

---

### 2. 해결 방법: Flash 전용 프롬프트 강화

#### 변경 사항 요약

**파일**: `data_processing/extract_metadata_hybrid.py`

**1) Pro 프롬프트를 Flash에도 완전 적용**
- 기존: Flash는 간소화된 프롬프트 사용
- 변경: Pro의 상세 프롬프트를 Flash에도 동일하게 적용
- 위치: Lines 1007-1105

**2) 회의록 구조 이해 섹션 추가** ⭐ 신규
```
**회의록 구조 이해:**
- 회의록은 "---" 구분선으로 섹션이 나뉘어져 있음
- 각 "---" 구분선 사이에 실제 발언("○위원장", "○위원" 등)이 포함된 구간은 하나의 안건으로 추출
- 첨부 문서(download_url)는 해당 안건 논의 직후에 "(참고)" 형태로 제공되며, 바로 앞 안건의 attachments에 매핑
- line_start는 실제 발언이 시작되는 첫 라인, line_end는 발언이 끝나는 마지막 라인 ("---" 구분선이나 "(참고)" 섹션 직전)
```
- 위치: Lines 1041-1048

**3) 구조적 요소 필터링 추가** (순수 코드 파싱 단계)
```python
# parse_section_pure 함수에 추가 (Lines 567-576)

# 구조적 요소 필터링
if line.startswith('---'):
    continue
if '(참고)' in line:
    continue
if '(회의록 끝에 실음)' in line:
    continue
# 안건 번호 라인 필터링 (예: "1. 안건명 [](url)" 형태)
if re.match(r'^\d+\.\s+.+\[\]\(https?://', line):
    continue
```
- 목적: chunks.text에 `---`, `(참고)`, URL 등이 포함되지 않도록 필터링
- 위치: Lines 567-576

---

### 3. 테스트 결과

#### 테스트 1: 랜덤 3개 파일 파싱 (Flash 모델)
```bash
# 실행 명령
cd data_processing
python process_all_result_folders.py 3
```

**결과**:
- ✅ 성공: 3개 파일
- ✅ 첨부 문서 추출 확인 필요 (아직 미검증)

**생성된 파일**:
```
data/result_txt/제332회 도시계획균형위원회 제1차(2025.09.01).json
data/result_txt/제332회 기획경제위원회 제2차(2025.09.02).json
data/result_txt/제332회 교육위원회 제1차(2025.09.01).json
```

#### 테스트 2: 첨부 문서 추출 검증

**검증한 파일**: `제332회 도시계획균형위원회 제1차(2025.09.01).json`

**결과**: ✅ **완벽하게 추출됨!**

| 안건 | 첨부 문서 수 (JSON) | 첨부 문서 수 (MD 원본) | 상태 |
|------|---------------------|------------------------|------|
| 2. 행정사무감사 계획 | 1개 | 1개 | ✅ 일치 |
| 3. 도심 복합개발 조례안 | 3개 | 3개 | ✅ 일치 |
| 4. 도시계획 조례 개정안 | 3개 | 3개 | ✅ 일치 |
| 5. 경관 조례 개정안 | 3개 | 3개 | ✅ 일치 |
| 6. 한양대학교 의견청취 | 2개 | 2개 | ✅ 일치 |
| 7. 도시정비기본계획 변경 | 2개 | 2개 | ✅ 일치 |
| 8. 추가경정예산안 | 1개 | 1개 | ✅ 일치 |
| 9. 도시공간본부 업무보고 | 1개 | 1개 | ✅ 일치 |
| 10. 법령개정 건의사항 | 1개 | 1개 | ✅ 일치 |

**세부 확인 사항**:
- ✅ 제목(title) 정확
- ✅ download_url 정확
- ✅ 누락 없음
- ✅ 중복 없음

#### 테스트 3: chunks.text 깨끗함 확인

**랜덤 5개 chunk 샘플링 결과**:
```
Chunk #83 (정관 개정안 보고): ✅ 깨끗함 (구조적 요소 없음)
Chunk #205 (현안업무보고): ✅ 깨끗함
Chunk #232 (현안업무보고): ✅ 깨끗함
Chunk #267 (현안업무보고): ✅ 깨끗함
Chunk #278 (현안업무보고): ✅ 깨끗함
```

**확인 항목**:
- ❌ `---` (구분선) 없음
- ❌ `(참고)` 없음
- ❌ URL 없음
- ❌ `(회의록 끝에 실음)` 없음
- ✅ **순수 발언 텍스트만 포함**

---

## 📊 현재 시스템 상태

### 데이터 파이프라인

```
1. 크롤링 (crawling/)
   ├─ extract_session_332_links.py: 회의록 URL 목록 추출
   └─ crawl_all_urls.py: 회의록 다운로드 (md, txt, json)

2. 하이브리드 파싱 (data_processing/)
   ├─ extract_metadata_hybrid.py: Stage 1 (Gemini) + Stage 2 (순수 코드)
   │  ├─ Stage 1: 안건 라인 매핑 추출 (Gemini Flash)
   │  └─ Stage 2: 발언 추출 (순수 Python 코드)
   └─ process_all_result_folders.py: 배치 처리 (10개 병렬)

3. 벡터 DB 생성 (database/)
   └─ insert_to_chromadb.py: ChromaDB에 청크 삽입

4. 관계형 DB 생성 (database/)
   ├─ create_agenda_database.py: SQLite DB 생성 (안건 메타데이터)
   └─ generate_ai_summaries.py: AI 요약 생성 (비동기 병렬)

5. 백엔드 서버 (app.py)
   ├─ repositories/: DB 접근 계층 (ChromaDB, SQLite)
   ├─ services/: 비즈니스 로직 계층
   └─ 라우팅: 검색, 안건 상세, Top 안건
```

### 주요 파일 구조

```
seoulloc/
├── data_processing/
│   ├── extract_metadata_hybrid.py      # ⭐ 오늘 수정 (프롬프트 강화)
│   ├── parse_with_pure_code.py         # ⭐ 오늘 수정 (필터링 추가)
│   └── process_all_result_folders.py
│
├── database/
│   ├── create_agenda_database.py
│   ├── generate_ai_summaries.py
│   └── insert_to_chromadb.py
│
├── repositories/
│   ├── agenda_repository.py
│   └── chroma_repository.py
│
├── services/
│   ├── agenda_service.py
│   └── agenda_search_service.py
│
├── app.py                              # FastAPI 백엔드
│
├── frontend/
│   ├── main.html
│   ├── search.html
│   └── details.html
│
└── data/
    ├── result_txt/                     # ⭐ JSON 파일 (파싱 결과)
    ├── chroma_db/                      # ChromaDB 벡터 DB
    └── sqlite_DB/agendas.db            # SQLite 관계형 DB
```

---

## 🔧 현재 설정 및 환경

### 모델 설정

**Gemini 모델**: `gemini-2.5-flash`
- 위치: `data_processing/extract_metadata_hybrid.py` Line 1108
- 비용: Pro 대비 90% 저렴
- 속도: 빠름
- 정확도: 프롬프트 개선 후 Pro와 동일 수준

**OpenAI 모델**: `gpt-4o-mini`
- 위치: `search/query_analyzer.py`
- 용도: 사용자 쿼리 분석 (메타데이터 추출)

### 필터링 규칙

**agenda_type 필터링** (검색 및 Top 안건):
```python
EXCLUDED_AGENDA_TYPES = ["procedural", "discussion", "other"]
```
- `procedural`: 개의, 산회 등 절차적 안건
- `discussion`: 질의응답, 토론
- `other`: 기타 발언

**구조적 요소 필터링** (chunks.text):
- `---` (구분선)
- `(참고)` (첨부 문서 섹션)
- `(회의록 끝에 실음)`
- `1. 안건명 [](url)` (안건 번호 라인)

---

## ✅ 검증 완료 사항

### 1. 첨부 문서 추출
- ✅ Flash 모델로 첨부 문서 정확히 추출
- ✅ MD 원본과 100% 일치
- ✅ 제목, URL 모두 정확
- ✅ 누락 없음, 중복 없음

### 2. chunks.text 깨끗함
- ✅ 구조적 요소(---, (참고), URL) 필터링 완료
- ✅ 순수 발언 텍스트만 포함
- ✅ 랜덤 샘플 검증 통과

### 3. 안건 라인 매핑 정확도
- ✅ line_start, line_end 정확
- ✅ 발언 누락 없음
- ✅ 발언자 추적 정상 작동

---

## 🚀 내일(11/25) 해야 할 작업

### 우선순위 1: 나머지 2개 파일 첨부 문서 검증 (필수)

**목적**: 오늘 테스트한 3개 파일 중 1개만 검증함. 나머지 2개도 확인 필요.

**검증할 파일**:
1. `제332회 기획경제위원회 제2차(2025.09.02).json`
2. `제332회 교육위원회 제1차(2025.09.01).json`

**검증 방법**:
```python
# 각 파일의 attachments를 MD 원본과 비교
# 1. JSON 파일에서 attachments 추출
# 2. MD 파일에서 "(참고)" 섹션의 첨부 문서 추출
# 3. 개수, 제목, URL 일치 확인
```

**예상 결과**: ✅ 모두 일치할 것으로 예상

---

### 우선순위 2: 전체 데이터 재생성 (필수)

**목적**: 개선된 프롬프트로 전체 회의록 재파싱

**단계별 실행**:

```bash
# 1. 전체 JSON 재생성 (약 10분 소요)
cd /mnt/c/Users/SBA/Project/seoulloc
conda activate seoul
python data_processing/process_all_result_folders.py

# 예상 결과:
# - result/ 폴더의 모든 md 파일 파싱
# - data/result_txt/에 JSON 파일 생성
# - 첨부 문서 포함, 구조적 요소 제거

# 2. ChromaDB 재생성 (약 2분)
python database/insert_to_chromadb.py

# 3. SQLite DB 재생성 (약 1분)
python database/create_agenda_database.py

# 4. AI 요약 재생성 (약 5-10분, 비동기 병렬)
python database/generate_ai_summaries.py

# 5. 서버 실행 및 테스트
python app.py
```

**⚠️ 주의**: 위 명령어들은 사용자가 직접 실행해야 합니다.

**확인 사항**:
- [ ] JSON 파일 개수 확인 (약 50개 이상)
- [ ] 첨부 문서 포함 여부
- [ ] chunks.text 깨끗함
- [ ] DB 정상 생성
- [ ] AI 요약 정상 생성

---

### 우선순위 3: 프론트엔드 테스트 (중요도: 높음)

**테스트 항목**:

1. **메인 페이지** (`http://localhost:8000`)
   - [ ] Top 5 안건 표시
   - [ ] AI 요약 표시
   - [ ] 안건 클릭 → 상세 페이지 이동

2. **검색 페이지**
   - [ ] 검색어: "인공지능" → 관련 안건 표시
   - [ ] AI 요약 표시
   - [ ] 첨부 문서 표시 (있는 경우)
   - [ ] procedural/discussion/other 타입 안건 제외 확인

3. **상세 페이지**
   - [ ] 안건 정보 표시
   - [ ] AI 요약 표시
   - [ ] 핵심 의제 표시
   - [ ] 첨부 문서 목록 표시 ⭐ **신규 기능 확인 필요**
   - [ ] 회의록 전체 내용 표시
   - [ ] 발언자별 텍스트 그룹핑

---

### 우선순위 4: 첨부 문서 다운로드 기능 검증 (선택)

**현재 상황**:
- JSON에 `attachments` 배열 저장됨
- `title`, `download_url` 포함
- 프론트엔드에서 아직 표시 안 함 (구현 필요?)

**확인 필요**:
1. 프론트엔드에서 첨부 문서 목록 표시하는지?
2. 다운로드 링크 클릭 가능한지?
3. UI 개선 필요한지?

---

## 📝 코드 수정 내역 (11/24)

### 1. `data_processing/extract_metadata_hybrid.py`

**Line 1007-1105**: Flash 프롬프트를 Pro 프롬프트로 교체
```python
# 기존: 간소화된 Flash 프롬프트
# 변경: Pro의 상세 프롬프트 적용

prompt = f"""다음은 서울시의회 회의록입니다. 이 회의록을 분석하여 안건별 라인 번호 매핑을 추출해주세요.

회의록 제목: {title}
회의록 URL: {url}
{attachments_text}

회의록 내용 (라인 번호 포함):
{numbered_text}

작업:
1. meeting_info 추출
2. agenda_mapping 추출

**안건 식별 규칙:**
...

**회의록 구조 이해:** ⭐ 신규 추가
- 회의록은 "---" 구분선으로 섹션이 나뉘어져 있음
- 각 "---" 구분선 사이에 실제 발언이 포함된 구간은 하나의 안건으로 추출
- 첨부 문서는 해당 안건 논의 직후에 "(참고)" 형태로 제공됨
- line_start는 실제 발언 시작, line_end는 발언 끝 ("---"나 "(참고)" 직전)

**첨부 문서 매칭:**
- 회의록 본문에서 마크다운 링크 형식의 첨부 문서를 찾아서 매칭
- 형식: [문서명](https://ms.smc.seoul.kr/record/appendixDownload.do?key=...)
- (참고) 섹션의 링크는 바로 직전 안건에 속함
...
"""
```

**Line 1041-1048**: 회의록 구조 이해 섹션 추가

### 2. `data_processing/extract_metadata_hybrid.py` (parse_section_pure)

**Line 567-576**: 구조적 요소 필터링 추가
```python
# 구조적 요소 필터링
if line.startswith('---'):
    continue
if '(참고)' in line:
    continue
if '(회의록 끝에 실음)' in line:
    continue
# 안건 번호 라인 필터링
if re.match(r'^\d+\.\s+.+\[\]\(https?://', line):
    continue
```

---

## 🐛 알려진 이슈

### 1. Chunk #2, #5에 URL 포함 (해결 완료)

**문제**: 안건 제목 라인(`1. 안건명 [](url)`)이 별도 chunk로 추출됨

**원인**: 안건 제목 라인에 URL이 포함되어 있음

**해결**: Line 575에서 정규식으로 필터링 추가
```python
if re.match(r'^\d+\.\s+.+\[\]\(https?://', line):
    continue
```

**검증 필요**: 내일 전체 재생성 후 chunk에 URL이 없는지 확인

---

## ⚠️ 주의사항

### 1. 환경 설정

**Conda 환경**: `seoul`
```bash
conda activate seoul
```

**필수 패키지**:
- `google-generativeai` (Gemini)
- `openai` (GPT-4o-mini, Embedding)
- `chromadb` (벡터 DB)
- `fastapi`, `uvicorn` (백엔드)

### 2. API 키

**.env 파일 필수**:
```
GOOGLE_API_KEY=your-key
OPENAI_API_KEY=your-key
```

### 3. 실행 위치

**반드시 프로젝트 루트에서 실행**:
```bash
cd /mnt/c/Users/SBA/Project/seoulloc
python data_processing/process_all_result_folders.py
```

### 4. 코드 실행 원칙 ⭐ 중요

**AI는 코드 분석만 수행, 실행은 사용자가 직접**:
- ✅ AI의 역할: 코드 분석, 버그 발견, 개선 제안, 실행 명령어 제시
- ❌ AI가 하지 않는 것: 테스트 실행, 스크립트 실행, conda 환경 활성화
- 📌 **모든 코드 실행(테스트, 데이터 생성, 서버 실행 등)은 사용자가 직접 수행**

**이유**:
- 사용자가 실행 과정을 직접 확인하고 제어
- 예상치 못한 부작용 방지
- 실행 결과를 사용자가 직접 검증

### 5. 재생성 시 주의

**순서 중요**:
1. JSON 생성
2. ChromaDB 생성
3. SQLite DB 생성
4. AI 요약 생성

**이유**: 각 단계가 이전 단계의 결과에 의존함

---

## 💡 핵심 개선 사항 (11/24)

### 1. Flash 모델로 첨부 문서 추출 성공 ✅

**이전**: Flash는 첨부 문서 누락
**현재**: Flash로도 첨부 문서 100% 추출
**방법**: Pro 프롬프트 적용 + 구조 이해 섹션 추가

### 2. chunks.text 구조적 요소 제거 ✅

**이전**: `---`, `(참고)`, URL 포함됨
**현재**: 순수 발언 텍스트만 포함
**방법**: parse_section_pure 함수에 필터링 로직 추가

### 3. 비용 절감 유지 ✅

**Pro 모델**: $0.05/1K 입력 토큰
**Flash 모델**: $0.005/1K 입력 토큰 (10배 저렴)
**결과**: 정확도는 Pro 수준, 비용은 Flash 수준

---

## 📊 예상 데이터 규모 (전체 재생성 후)

**회의록 파일 수**: 약 50개 (result/ 폴더)
**안건 수**: 약 300-500개 (추정)
**청크 수**: 약 10,000-20,000개 (추정)
**AI 요약 소요 시간**: 약 10-20분 (비동기 병렬 처리)

---

## 🎯 성공 기준

### 내일 작업 완료 후 확인 사항

- [ ] 나머지 2개 파일 첨부 문서 검증 통과
- [ ] 전체 JSON 재생성 완료 (약 50개 파일)
- [ ] 첨부 문서가 모든 안건에 정확히 포함됨
- [ ] chunks.text에 구조적 요소 없음
- [ ] ChromaDB, SQLite DB 정상 생성
- [ ] AI 요약 정상 생성
- [ ] 프론트엔드에서 첨부 문서 표시 확인
- [ ] 검색 기능 정상 작동
- [ ] Top 5 안건 정상 표시

---

**마지막 업데이트**: 2025-11-24
**작업 완료**: Gemini Flash 프롬프트 개선 + 구조적 요소 필터링
**다음 작업**: 나머지 파일 검증 + 전체 데이터 재생성
